---
title: "Malaise-trap samples linear model"
author: "Mingjie"
date: "12/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r library packages}
library(tidyverse)
library(lulu)
library(sjmisc)
library(modelr)
library(here)
library(cowplot)
library(patchwork)
library(DataExplorer)
```

```{r read in data}
otus <- read.table(here( 'data','sumaclust_97_otutalbe.txt'), sep = '\t', header = T)
lysisbuffer <- read.csv(here('data','lysis_buffer_volume_20200724.csv'), header = T)
seqs <- otus %>% select(OTU,Seq)
dilution_otus <- otus %>% select(OTU, starts_with("X"), starts_with("HB"), starts_with("PNC"))
dilution_otus <- column_to_rownames(dilution_otus, var="OTU")
dilution_rowsum <- rowSums(dilution_otus) #sum within rows. Sum OTU reads through samples.
range(dilution_rowsum)
dilution_otuID <- names(which(dilution_rowsum >= 1))
dilution_otus <- rownames_to_column(dilution_otus, var = "OTU")
dilution_otus <- dplyr::filter(dilution_otus, OTU %in% dilution_otuID) #1188 OTUs to 1102 OTUs

seqs <- dplyr::filter(seqs, OTU %in% dilution_otuID)
write.table(seqs, file = "dilution_otus_seqs.txt", row.names = F, col.names = F, quote = F, sep = ":")
matchlist <- read.table(here("data",'sumaclust_matchlist.txt'))
dilution_otus <- column_to_rownames(dilution_otus, var = "OTU")
```


```{r lulu}
lulu_results <- lulu(dilution_otus, matchlist)
lulu_otus <- lulu_results$curated_table #1102 OTUs collapse to 435 OTUs.
lulu_otuID <- lulu_otus$OTU
#write.table(lulu_otuID, file = "dilution_lulu_otuID.txt", col.names = F, row.names = F, quote = F)

#change sample naems
lulu_otus <- rownames_to_column(lulu_otus, var = "OTU")
lulu_otus <- pivot_longer(lulu_otus, names_to = "samples", values_to = "reads", -OTU)
lulu_otus$samples <- str_remove(lulu_otus$samples, "X") 
lulu_otus <- pivot_wider(lulu_otus, names_from = "samples", values_from = "reads")
#write.table(lulu_otus, file = "dilution_otutable_lulu.txt", row.names = F, quote = F)
```


spike 1-2: OTU1
spike 2-1: OTU16
spike 3-1: OTU2
```{r reformate data}
which(lulu_otus$OTU == "OTU1") #1
which(lulu_otus$OTU == "OTU2") #100
which(lulu_otus$OTU == "OTU16") #77
lulu_otus[1,1] = "spike1-2"
lulu_otus[100,1] = "spike3-1"
lulu_otus[77,1] = "spike2-1"

longReadNum <- pivot_longer(lulu_otus, names_to = "sampleName", values_to = "OTUsize", -OTU)
dd=longReadNum

#parse sample information
dd$dilution = substr(dd$sampleName,14,14)
dd$sample = substr(dd$sampleName,1,12)
```

```{r spike correction with 2 speceis}
#3-1:2-1=1:9
dd <- dd %>%
      dplyr::group_by(sampleName) %>%
      filter( ! sampleName %in% c("PNC55","PNC56", "PNC57", "PNC58", "PNC59") )%>% 
      dplyr::mutate(readSpikeSum = (OTUsize[OTU=='spike2-1']/9 + OTUsize[OTU=='spike3-1'])/2)

range(dd$readSpikeSum)   
```

```{r add input}
dd$inputDNA <- substr(dd$sampleName, nchar(dd$sampleName), nchar(dd$sampleName))
dd$inputDNA <- str_replace_all(dd$inputDNA, c("A"="1", "B"="0.7", "C"="0.49", "D"="0.343", "E"="0.24", "F"="0.16"))
dd$inputDNA <- as.numeric(dd$inputDNA)

```

#0 can not be logged, log(x+1) makes results a little bit strange
```{r rm 0}
dd <- dd %>%
  dplyr::filter(OTUsize != 0) %>% 
  arrange(sampleName)
```

```{r calculate FSL}
lysisbuffer <- lysisbuffer %>% dplyr::filter(sample %in% c("123545_M1_S1", "124031_M1_S1", "286789_M1_S1", "357256_M2_S1", "700239_M1_S1", "HOBO_053_M1_S1","HOBO_216_M1_S1"))

lysisbuffer$sample <- str_replace_all(lysisbuffer$sample, "_", ".")
lysisbuffer$sample <- str_replace(lysisbuffer$sample, "HOBO", "HB")
dd <- full_join(dd, lysisbuffer)
dd <- dd %>% 
  mutate(lysisBufferFrac = aliquot/added.lysis.buffer.ml.) %>% 
  mutate(FSL = OTUsize/(readSpikeSum*lysisBufferFrac)*min(dd$readSpikeSum))

plot_histogram(dd)
hist(log(dd$FSL))
```

```{r rm spike}
dd <- dd %>% 
  dplyr::filter(! OTU %in% c("spike1-2", "spike2-1", "spike3-1"))
```


```{r write table}
#write.csv(dd, file="Malaise-trap_Samples_20211228.csv", row.names = F, quote = F)
```


```{r linear model GDNA}
plot(log(dd$inputDNA) ~ log(dd$OTUsize))
lmGDNA_OTUsize <- lm(log10(inputDNA) ~ log10(OTUsize) + OTU, dd)
lmGDNA_FSL <- lm(log10(inputDNA) ~ log10(FSL) + OTU, dd)

summary(lmGDNA_OTUsize)
summary(lmGDNA_FSL)
```


```{r ggplot gDNA}
dd$sample2 <-  str_replace_all(dd$sample, c("123545.M1.S1" = "Sample 1", "124031.M1.S1" = "Sample 2", "286789.M1.S1" = "Sample 3", "357256.M2.S1" = "Sample 4", "700239.M1.S1" = "Sample 5", "HB.053.M1.S1" = "Sample 6", "HB.216.M1.S1" = "Sample 7"))

#dd <- add_predictions(dd, lmGDNA_OTUsize, var = 'fittedOTUsize')
#dd <- add_predictions(dd, lmGDNA_FSL, var = 'fittedFSL')

#use geom_smooth
ggplotGDNA_OTUsize <- ggplot(dd) + 
  geom_point(aes(y=log10(inputDNA), x = log10(OTUsize), color = OTU)) + 
  geom_smooth(aes(x = log10(OTUsize), y = log10(inputDNA), color = OTU), method = lm, se = FALSE, method.args = list()) +  
  labs(x = 'non-spike-corrected OTU size', y = 'input genomic DNA mass') + 
  theme(legend.position = "none") + 
  facet_wrap(~sample2) 

ggplotGDNA_FSL <- ggplot(dd) + 
  geom_point(aes(y=log10(inputDNA), x = log10(FSL), color = OTU)) + 
  geom_smooth(aes(x = log10(FSL), y = log10(inputDNA), color = OTU), method = lm, se = FALSE) +  
  labs(x = 'spike-corrected OTU size', y = 'input genomic DNA mass') + 
  theme(legend.position = "none") +
  facet_wrap(~sample2)

ggplotGDNA_OTUsize + ggplotGDNA_FSL
```



## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
